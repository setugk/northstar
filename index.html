<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0b">
  <title>Northstar</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0b;
      --surface: #18181b;
      --surface-hover: #27272a;
      --border: #3f3f46;
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --accent: #818cf8;
      --accent-dim: rgba(129, 140, 248, 0.18);
      --success: #4ade80;
      --success-dim: rgba(74, 222, 128, 0.18);
      --warning: #fbbf24;
      --warning-dim: rgba(251, 191, 36, 0.12);
      --danger: #f87171;
      --radius: 12px;
      --radius-sm: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 24px 20px;
      padding-bottom: 100px;
    }

    /* Header */
    .header {
      margin-bottom: 24px;
    }

    .greeting {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .card-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 10px;
    }

    /* Buttons */
    .btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: #0a0a0b;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--surface-hover);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-block {
      width: 100%;
    }

    /* Section */
    .section {
      margin-bottom: 24px;
    }

    .section-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Goal Cards */
    .goal-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .goal-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .goal-number {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .goal-info {
      flex: 1;
      min-width: 0;
    }

    .goal-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .goal-progress-text {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .goal-progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .goal-progress-fill {
      height: 100%;
      background: var(--success);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .goal-chevron {
      color: var(--text-tertiary);
      transition: transform 0.2s ease;
    }

    .goal-card.expanded .goal-chevron {
      transform: rotate(180deg);
    }

    .goal-tasks {
      display: none;
      border-top: 1px solid var(--border);
    }

    .goal-card.expanded .goal-tasks {
      display: block;
    }

    /* Task Items */
    .task-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
      transition: all 0.15s ease;
    }

    .task-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
    }

    .task-checkbox svg {
      width: 12px;
      height: 12px;
      opacity: 0;
    }

    .task-checkbox.checked svg {
      opacity: 1;
    }

    .task-content {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .task-item.completed .task-title {
      color: var(--text-tertiary);
      text-decoration: line-through;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .task-time {
      font-size: 12px;
      color: var(--text-tertiary);
      background: var(--surface-hover);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .task-link {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .task-link:hover {
      text-decoration: underline;
    }

    .task-date {
      font-size: 11px;
      color: var(--success);
    }

    /* Today View - Selectors */
    .selector-group {
      margin-bottom: 20px;
    }

    .selector-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .selector-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .selector-btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .selector-btn:hover {
      background: var(--surface-hover);
    }

    .selector-btn.selected {
      border-color: var(--accent);
      background: var(--accent-dim);
      color: var(--text-primary);
    }

    .selector-btn.goal-selector {
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .selector-btn.goal-selector .goal-number {
      width: 24px;
      height: 24px;
      font-size: 12px;
    }

    /* Task Suggestion Card */
    .suggestion-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      padding: 20px;
      margin-bottom: 16px;
    }

    .suggestion-header {
      font-size: 12px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .suggestion-title {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .suggestion-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .suggestion-time {
      font-size: 13px;
      color: var(--text-secondary);
      background: var(--surface-hover);
      padding: 4px 10px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .suggestion-links {
      margin-bottom: 16px;
    }

    .suggestion-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--surface-hover);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      text-decoration: none;
      color: var(--text-primary);
      font-size: 14px;
      transition: background 0.15s ease;
    }

    .suggestion-link:hover {
      background: var(--border);
    }

    .suggestion-link svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .suggestion-link-text {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .suggestion-notes {
      font-size: 14px;
      color: var(--text-secondary);
      padding: 12px 0;
      margin-bottom: 16px;
      line-height: 1.5;
      border-top: 1px solid var(--border);
    }

    .suggestion-actions {
      display: flex;
      gap: 10px;
    }

    .suggestion-actions .btn {
      flex: 1;
    }

    /* Empty / No Selection State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-tertiary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      line-height: 1.5;
    }

    /* Config Upload */
    .upload-input {
      display: none;
    }

    /* Diff Preview */
    .diff-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .diff-overlay.visible {
      display: flex;
    }

    .diff-modal {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .diff-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 16px;
    }

    .diff-content {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .diff-section {
      margin-bottom: 16px;
    }

    .diff-section:last-child {
      margin-bottom: 0;
    }

    .diff-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .diff-item {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 4px;
    }

    .diff-item.added {
      background: var(--success-dim);
      color: var(--success);
    }

    .diff-item.removed {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
    }

    .diff-item.unchanged {
      color: var(--text-tertiary);
    }

    .diff-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .diff-footer .btn {
      flex: 1;
    }

    .diff-errors {
      padding: 12px 16px;
      background: rgba(248, 113, 113, 0.1);
      border-bottom: 1px solid var(--danger);
    }

    .diff-error-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--danger);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .diff-error-item {
      font-size: 13px;
      color: var(--danger);
      padding: 4px 0;
    }

    .btn-disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      font-size: 14px;
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Quarter Badge */
    .quarter-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--accent-dim);
      color: var(--accent);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: center;
      gap: 32px;
      padding: 12px 20px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 4px 16px;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
    }

    .nav-label {
      font-size: 11px;
    }

    /* Lock Screen */
    .lock-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 200;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 32px;
    }

    .lock-screen.hidden {
      display: none;
    }

    .lock-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text-primary);
    }

    .lock-subtitle {
      font-size: 14px;
      color: var(--text-tertiary);
      margin-top: -20px;
    }

    .pin-inputs {
      display: flex;
      gap: 12px;
    }

    .pin-digit {
      width: 48px;
      height: 56px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      outline: none;
      transition: border-color 0.15s ease;
      -webkit-text-security: disc;
    }

    .pin-digit:focus {
      border-color: var(--accent);
    }

    .pin-inputs.shake {
      animation: shake 0.4s ease;
    }

    .pin-inputs.shake .pin-digit {
      border-color: var(--danger);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }

    /* Views */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* All tasks complete state */
    .complete-state {
      text-align: center;
      padding: 40px 20px;
    }

    .complete-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .complete-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--success);
      margin-bottom: 8px;
    }

    .complete-state-desc {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* No matching tasks */
    .no-match-state {
      background: var(--warning-dim);
      border: 1px solid var(--warning);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .no-match-state-title {
      font-size: 15px;
      color: var(--warning);
      margin-bottom: 6px;
    }

    .no-match-state-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .app-footer {
      text-align: center;
      padding: 24px 0 8px;
      font-size: 11px;
      color: var(--text-tertiary);
    }

    /* Header actions */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Meatball menu */
    .menu-wrapper {
      position: relative;
    }

    .menu-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px 8px;
      display: flex;
      align-items: center;
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      min-width: 160px;
      z-index: 50;
      overflow: hidden;
    }

    .menu-dropdown.open {
      display: block;
    }

    .menu-item {
      width: 100%;
      padding: 10px 14px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      text-align: left;
      cursor: pointer;
    }

    .menu-item:hover {
      background: var(--surface-hover);
    }

    .menu-item.danger {
      color: var(--danger);
    }

    /* Confirm overlay */
    .confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .confirm-overlay.visible {
      display: flex;
    }

    .confirm-modal {
      background: var(--surface);
      border-radius: var(--radius);
      max-width: 340px;
      width: 100%;
      padding: 24px;
    }

    .confirm-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .confirm-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
    }

    .confirm-actions .btn {
      flex: 1;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Lock Screen -->
  <div class="lock-screen" id="lock-screen">
    <div class="lock-title">Northstar</div>
    <div class="lock-subtitle">Enter passcode</div>
    <div class="pin-inputs" id="pin-inputs">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
    </div>
  </div>

  <div class="container">
    <!-- Goals View -->
    <div class="view" id="view-goals">
      <div class="header" style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <div class="greeting" id="quarter-display">Q1 2026</div>
          <div class="page-title">Goals</div>
        </div>
        <div class="header-actions">
          <button class="btn btn-ghost btn-sm" id="upload-btn">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17,8 12,3 7,8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload
          </button>
          <div class="menu-wrapper">
            <button class="menu-btn" id="menu-btn">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
              </svg>
            </button>
            <div class="menu-dropdown" id="menu-dropdown">
              <button class="menu-item danger" id="reset-btn">Reset to default</button>
            </div>
          </div>
        </div>
        <input type="file" class="upload-input" id="upload-input" accept=".md,.txt">
      </div>

      <div class="card" id="overall-progress-card" style="margin-bottom: 20px;">
        <!-- Dynamic content -->
      </div>

      <div class="section-header">Focus Areas</div>
      <div id="goals-list">
        <!-- Dynamic content -->
      </div>
    </div>

    <!-- Today View -->
    <div class="view active" id="view-today">
      <div class="header">
        <div class="greeting" id="greeting">Good evening</div>
        <div class="page-title" id="current-date">Thursday, Jan 29</div>
      </div>

      <div class="selector-group">
        <div class="selector-label">What goal do you want to work on?</div>
        <div class="selector-options" id="goal-selector">
          <!-- Dynamic content -->
        </div>
      </div>

      <div class="selector-group">
        <div class="selector-label">How much time do you have?</div>
        <div class="selector-options" id="time-selector">
          <button class="selector-btn" data-time="15">15 min</button>
          <button class="selector-btn" data-time="30">30 min</button>
          <button class="selector-btn" data-time="60">1 hour</button>
          <button class="selector-btn" data-time="120">2 hours</button>
        </div>
      </div>

      <div id="task-suggestion">
        <!-- Dynamic content -->
      </div>
    </div>


    <div class="app-footer" id="app-footer"></div>

  </div>

  <!-- Diff Preview Overlay -->
  <div class="diff-overlay" id="diff-overlay">
    <div class="diff-modal">
      <div class="diff-header">Review Changes</div>
      <div class="diff-content" id="diff-content">
        <!-- Dynamic content -->
      </div>
      <div class="diff-footer">
        <button class="btn btn-ghost" id="diff-cancel">Cancel</button>
        <button class="btn btn-primary" id="diff-confirm">Apply Changes</button>
      </div>
    </div>
  </div>

  <!-- Reset Confirmation -->
  <div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-modal">
      <div class="confirm-title">Reset to default?</div>
      <div class="confirm-desc">This will clear all your goals, tasks, and progress and replace them with the default sample content.</div>
      <div class="confirm-actions">
        <button class="btn btn-ghost" id="confirm-cancel">Cancel</button>
        <button class="btn btn-danger" id="confirm-reset">Reset</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <nav class="bottom-nav">
    <button class="nav-item active" data-view="today">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      <span class="nav-label">Today</span>
    </button>
    <button class="nav-item" data-view="goals">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v8m-4-4h8"/>
      </svg>
      <span class="nav-label">Goals</span>
    </button>
  </nav>

  <script>
    // ============ VERSION ============
    const APP_VERSION = '1.4';
    document.getElementById('app-footer').innerHTML = `Northstar v${APP_VERSION} &copy; Setu Kathawate`;

    // ============ AUTH ============
    const PASSCODE_HASH = '44c59909f17c296d6f2ec4a53efac3a951add75aa67616d9c5d9d2f5fbb44f04';
    const AUTH_KEY = 'northstar-auth';
    const AUTH_DURATION_MS = 30 * 24 * 60 * 60 * 1000; // 30 days

    async function hashPin(pin) {
      const data = new TextEncoder().encode(pin);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function checkAuth() {
      const token = localStorage.getItem(AUTH_KEY);
      if (!token) return false;
      try {
        const { expiry } = JSON.parse(token);
        return Date.now() < expiry;
      } catch {
        return false;
      }
    }

    async function authenticate(pin) {
      const hash = await hashPin(pin);
      if (hash === PASSCODE_HASH) {
        localStorage.setItem(AUTH_KEY, JSON.stringify({ expiry: Date.now() + AUTH_DURATION_MS }));
        return true;
      }
      return false;
    }

    function logout() {
      localStorage.removeItem(AUTH_KEY);
    }

    function initLockScreen() {
      const lockScreen = document.getElementById('lock-screen');
      const container = document.querySelector('.container');
      const bottomNav = document.querySelector('.bottom-nav');
      const pinInputs = document.getElementById('pin-inputs');
      const digits = pinInputs.querySelectorAll('.pin-digit');

      if (checkAuth()) {
        lockScreen.classList.add('hidden');
        return;
      }

      // Hide app content while locked
      container.style.display = 'none';
      bottomNav.style.display = 'none';

      digits[0].focus();

      digits.forEach((input, i) => {
        input.addEventListener('input', () => {
          // Only allow digits
          input.value = input.value.replace(/[^0-9]/g, '');
          if (input.value && i < 3) {
            digits[i + 1].focus();
          }
          // Auto-submit when all 4 digits entered
          if (i === 3 && input.value) {
            const pin = Array.from(digits).map(d => d.value).join('');
            if (pin.length === 4) {
              authenticate(pin).then(success => {
                if (success) {
                  lockScreen.classList.add('hidden');
                  container.style.display = '';
                  bottomNav.style.display = '';
                } else {
                  pinInputs.classList.add('shake');
                  setTimeout(() => {
                    pinInputs.classList.remove('shake');
                    digits.forEach(d => d.value = '');
                    digits[0].focus();
                  }, 400);
                }
              });
            }
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !input.value && i > 0) {
            digits[i - 1].focus();
          }
        });
      });
    }

    // ============ STATE ============
    let state = {
      quarter: 'Q1 2026',
      goals: [],
      // Task completion state: { "1.1": { completed: true, completedAt: "2026-01-29" }, ... }
      taskState: {},
      // For "defer" - track order per goal session
      deferredThisSession: {}
    };

    // ============ LOAD/SAVE ============
    function loadState() {
      const saved = localStorage.getItem('focus-app-v2');
      if (saved) {
        const parsed = JSON.parse(saved);
        state = { ...state, ...parsed };
      }
      
      // Load default config if no goals
      if (state.goals.length === 0) {
        loadDefaultConfig();
      }
    }

    function saveState() {
      localStorage.setItem('focus-app-v2', JSON.stringify(state));
    }

    function loadDefaultConfig() {
      state.quarter = 'Q1 2026';
      state.goals = [
        {
          id: '1.0',
          title: 'Get better at public speaking',
          tasks: [
            {
              id: '1.1',
              title: 'Watch a TED talk and note 3 techniques the speaker uses',
              time: 15,
              links: [{ label: 'TED Talks', url: 'https://www.ted.com/talks' }],
              notes: 'Pay attention to pacing, pauses, and storytelling'
            },
            {
              id: '1.2',
              title: 'Practice a 2-minute elevator pitch and record yourself',
              time: 30,
              links: [{ label: 'Guide', url: 'https://hbr.org/2018/10/the-art-of-the-elevator-pitch' }],
              notes: 'Review the recording and note areas to improve'
            },
            {
              id: '1.3',
              title: 'Sign up for a local Toastmasters meeting',
              time: 15,
              links: [{ label: 'Toastmasters', url: 'https://www.toastmasters.org/find-a-club' }],
              notes: ''
            }
          ]
        },
        {
          id: '2.0',
          title: 'Read more books this quarter',
          tasks: [
            {
              id: '2.1',
              title: 'Pick 3 books and add them to a reading list',
              time: 15,
              links: [{ label: 'Goodreads', url: 'https://www.goodreads.com/list/popular_lists' }],
              notes: 'Mix of fiction and non-fiction'
            },
            {
              id: '2.2',
              title: 'Read for 30 minutes before bed',
              time: 30,
              links: [],
              notes: 'Put the phone away first'
            },
            {
              id: '2.3',
              title: 'Write a short review of the first book',
              time: 60,
              links: [{ label: 'Goodreads', url: 'https://www.goodreads.com' }],
              notes: 'Share it with a friend to start a conversation'
            }
          ]
        },
        {
          id: '3.0',
          title: 'Learn to cook 5 new recipes',
          tasks: [
            {
              id: '3.1',
              title: 'Browse recipes and pick 5 to try this quarter',
              time: 30,
              links: [{ label: 'Budget Bytes', url: 'https://www.budgetbytes.com' }],
              notes: 'Aim for a range of difficulty levels'
            },
            {
              id: '3.2',
              title: 'Buy ingredients and cook recipe #1',
              time: 120,
              links: [{ label: 'YouTube', url: 'https://www.youtube.com/@JoshuaWeissman' }],
              notes: 'Take a photo of the result'
            },
            {
              id: '3.3',
              title: 'Cook recipe #2 and compare notes',
              time: 120,
              links: [],
              notes: 'What went better this time?'
            }
          ]
        }
      ];
      saveState();
    }

    // ============ HELPERS ============
    function getTaskState(taskId) {
      return state.taskState[taskId] || { completed: false, completedAt: null };
    }

    function setTaskCompleted(taskId, completed) {
      if (completed) {
        state.taskState[taskId] = {
          completed: true,
          completedAt: new Date().toISOString().split('T')[0]
        };
      } else {
        state.taskState[taskId] = { completed: false, completedAt: null };
      }
      saveState();
    }

    function getGoalProgress(goal) {
      const total = goal.tasks.length;
      if (total === 0) return { completed: 0, total: 0, percent: 0 };
      const completed = goal.tasks.filter(t => getTaskState(t.id).completed).length;
      return {
        completed,
        total,
        percent: Math.round((completed / total) * 100)
      };
    }

    function getOverallProgress() {
      let totalTasks = 0;
      let completedTasks = 0;
      state.goals.forEach(g => {
        const p = getGoalProgress(g);
        totalTasks += p.total;
        completedTasks += p.completed;
      });
      return {
        completed: completedTasks,
        total: totalTasks,
        percent: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
      };
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function linkLabel(url) {
      try {
        const host = new URL(url).hostname.replace('www.', '');
        if (host.includes('youtube.com') || host.includes('youtu.be')) return 'Watch video';
        if (host.includes('medium.com') || host.includes('substack.com')) return 'Read post';
        return 'Read article';
      } catch {
        return 'Open link';
      }
    }

    function formatTime(minutes) {
      if (minutes < 60) return `${minutes} min`;
      if (minutes === 60) return '1 hour';
      if (minutes === 120) return '2 hours';
      return `${minutes} min`;
    }

    // ============ RENDER: GOALS VIEW ============
    function renderGoals() {
      const container = document.getElementById('goals-list');
      const progressCard = document.getElementById('overall-progress-card');
      document.getElementById('quarter-display').textContent = state.quarter;

      // Render overall progress
      const overall = getOverallProgress();
      progressCard.innerHTML = `
        <div class="card-label">Overall Progress</div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 32px; font-weight: 700; color: var(--success);">${overall.percent}%</span>
          <span style="font-size: 14px; color: var(--text-secondary);">${overall.completed}/${overall.total} tasks</span>
        </div>
        <div class="goal-progress-bar" style="height: 6px;">
          <div class="goal-progress-fill" style="width: ${overall.percent}%"></div>
        </div>
      `;

      if (state.goals.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“‹</div>
            <div class="empty-state-title">No goals configured</div>
            <div class="empty-state-desc">Upload a config.md file to get started</div>
          </div>
        `;
        return;
      }

      container.innerHTML = state.goals.map((goal, index) => {
        const progress = getGoalProgress(goal);
        return `
          <div class="goal-card" data-goal-index="${index}">
            <div class="goal-header">
              <div class="goal-number">${index + 1}</div>
              <div class="goal-info">
                <div class="goal-title">${escapeHtml(goal.title)}</div>
                <div class="goal-progress-text">${progress.completed}/${progress.total} tasks Â· ${progress.percent}%</div>
                <div class="goal-progress-bar">
                  <div class="goal-progress-fill" style="width: ${progress.percent}%"></div>
                </div>
              </div>
              <div class="goal-chevron">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="6,9 12,15 18,9"/>
                </svg>
              </div>
            </div>
            <div class="goal-tasks">
              ${goal.tasks.map(task => {
                const ts = getTaskState(task.id);
                return `
                  <div class="task-item ${ts.completed ? 'completed' : ''}" data-task-id="${task.id}">
                    <button class="task-checkbox ${ts.completed ? 'checked' : ''}">
                      <svg fill="none" stroke="white" stroke-width="3" viewBox="0 0 24 24">
                        <polyline points="20,6 9,17 4,12"/>
                      </svg>
                    </button>
                    <div class="task-content">
                      <div class="task-title">${escapeHtml(task.title)}</div>
                      <div class="task-meta">
                        <span class="task-time">${formatTime(task.time)}</span>
                        ${task.links.map(link => `
                          <a href="${escapeHtml(link.url)}" target="_blank" class="task-link">
                            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            ${linkLabel(link.url)}
                          </a>
                        `).join('')}
                        ${ts.completed && ts.completedAt ? `<span class="task-date">âœ“ ${ts.completedAt}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Event: toggle goal expand
      container.querySelectorAll('.goal-header').forEach(header => {
        header.addEventListener('click', () => {
          header.closest('.goal-card').classList.toggle('expanded');
        });
      });

      // Event: toggle task complete
      container.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskItem = checkbox.closest('.task-item');
          const taskId = taskItem.dataset.taskId;
          const currentState = getTaskState(taskId);
          setTaskCompleted(taskId, !currentState.completed);
          renderGoals();
        });
      });
    }

    // ============ RENDER: TODAY VIEW ============
    let selectedGoalIndex = null;
    let selectedTime = null;
    let currentSuggestedTask = null;

    function renderToday() {
      // Greeting
      const hour = new Date().getHours();
      let greeting = 'Good evening';
      if (hour < 12) greeting = 'Good morning';
      else if (hour < 17) greeting = 'Good afternoon';
      document.getElementById('greeting').textContent = greeting;

      const options = { weekday: 'long', month: 'short', day: 'numeric' };
      document.getElementById('current-date').textContent = 
        new Date().toLocaleDateString('en-US', options);

      // Goal selector
      const goalSelector = document.getElementById('goal-selector');
      goalSelector.innerHTML = state.goals.map((goal, index) => `
        <button class="selector-btn goal-selector ${selectedGoalIndex === index ? 'selected' : ''}" data-goal-index="${index}">
          <span class="goal-number">${index + 1}</span>
          <span>${escapeHtml(goal.title)}</span>
        </button>
      `).join('');

      goalSelector.querySelectorAll('.goal-selector').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedGoalIndex = parseInt(btn.dataset.goalIndex);
          state.deferredThisSession = {}; // Reset deferred on goal change
          renderToday();
          renderTaskSuggestion();
        });
      });

      // Time selector
      const timeSelector = document.getElementById('time-selector');
      timeSelector.querySelectorAll('.selector-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.time) === selectedTime);
        btn.onclick = () => {
          selectedTime = parseInt(btn.dataset.time);
          renderToday();
          renderTaskSuggestion();
        };
      });

      renderTaskSuggestion();
    }

    function renderTaskSuggestion() {
      const container = document.getElementById('task-suggestion');

      if (selectedGoalIndex === null || selectedTime === null) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ‘†</div>
            <div class="empty-state-title">Select a goal and time</div>
            <div class="empty-state-desc">I'll suggest a task for you to work on</div>
          </div>
        `;
        return;
      }

      const goal = state.goals[selectedGoalIndex];
      if (!goal) return;

      // Get incomplete tasks that fit the time
      const incompleteTasks = goal.tasks.filter(t => {
        const ts = getTaskState(t.id);
        return !ts.completed && t.time <= selectedTime;
      });

      if (incompleteTasks.length === 0) {
        // Check if all tasks are complete or just none match time
        const allComplete = goal.tasks.every(t => getTaskState(t.id).completed);
        
        if (allComplete) {
          container.innerHTML = `
            <div class="complete-state">
              <div class="complete-state-icon">ðŸŽ‰</div>
              <div class="complete-state-title">All tasks complete!</div>
              <div class="complete-state-desc">You've finished everything for "${escapeHtml(goal.title)}"</div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="no-match-state">
              <div class="no-match-state-title">No tasks fit this time</div>
              <div class="no-match-state-desc">Try selecting more time, or check the Goals tab for remaining tasks</div>
            </div>
          `;
        }
        return;
      }

      // Pick a random task (considering deferred ones go to bottom)
      const deferredKey = `${goal.id}`;
      const deferredIds = state.deferredThisSession[deferredKey] || [];
      
      // Prioritize non-deferred tasks
      let taskPool = incompleteTasks.filter(t => !deferredIds.includes(t.id));
      if (taskPool.length === 0) {
        // All have been deferred, reset and pick from all
        state.deferredThisSession[deferredKey] = [];
        taskPool = incompleteTasks;
      }

      const task = taskPool[Math.floor(Math.random() * taskPool.length)];
      currentSuggestedTask = task;

      container.innerHTML = `
        <div class="suggestion-card">
          <div class="suggestion-header">Suggested Task</div>
          <div class="suggestion-title">${escapeHtml(task.title)}</div>
          <div class="suggestion-meta">
            <span class="suggestion-time">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
              ${formatTime(task.time)}
            </span>
          </div>
          ${task.links.length > 0 ? `
            <div class="suggestion-links">
              ${task.links.map(link => `
                <a href="${escapeHtml(link.url)}" target="_blank" class="suggestion-link">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                    <polyline points="15,3 21,3 21,9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                  </svg>
                  <span class="suggestion-link-text">${linkLabel(link.url)}</span>
                </a>
              `).join('')}
            </div>
          ` : ''}
          ${task.notes ? `
            <div class="suggestion-notes">${escapeHtml(task.notes)}</div>
          ` : ''}
          <div class="suggestion-actions">
            <button class="btn btn-ghost" id="defer-btn">Not now</button>
            <button class="btn btn-success" id="complete-btn">Done âœ“</button>
          </div>
        </div>
      `;

      document.getElementById('defer-btn').addEventListener('click', () => {
        const deferredKey = `${goal.id}`;
        if (!state.deferredThisSession[deferredKey]) {
          state.deferredThisSession[deferredKey] = [];
        }
        state.deferredThisSession[deferredKey].push(task.id);
        renderTaskSuggestion();
      });

      document.getElementById('complete-btn').addEventListener('click', () => {
        setTaskCompleted(task.id, true);
        renderTaskSuggestion();
        renderGoals();
        renderProgress();
      });
    }

    // ============ CONFIG PARSER ============
    const VALID_TIMES = [15, 30, 60, 120];

    function cleanText(text) {
      return text.replace(/\s+/g, ' ').trim();
    }

    function parseTime(raw) {
      const match = raw.match(/^(\d+)\s*(m|min|mins|minutes|h|hr|hrs|hour|hours)$/i);
      if (!match) return null;
      let minutes = parseInt(match[1]);
      if (match[2].toLowerCase().startsWith('h')) {
        minutes *= 60;
      }
      return minutes;
    }

    function parseConfig(markdown) {
      const config = {
        quarter: 'Q1 2026',
        goals: [],
        errors: []
      };

      const lines = markdown.split('\n');
      let currentGoal = null;
      let currentTask = null;
      let inCodeBlock = false;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();

        // Skip code blocks (template examples in Reference section)
        if (trimmed.startsWith('```')) {
          inCodeBlock = !inCodeBlock;
          continue;
        }
        if (inCodeBlock) continue;

        // Quarter
        const quarterMatch = trimmed.match(/^\*\*Quarter:\*\*\s*(.+)$/i) || trimmed.match(/^Quarter:\s*(.+)$/i);
        if (quarterMatch) {
          config.quarter = cleanText(quarterMatch[1]);
          continue;
        }

        // Goal header (e.g., "### 1.0 Goal Title" or "| 1 | Goal Title |")
        const goalMatch = trimmed.match(/^###\s*(\d+\.0)\s+(.+)$/) ||
                          trimmed.match(/^\|\s*(\d+)\s*\|\s*(.+?)\s*\|/);
        if (goalMatch) {
          if (currentTask && currentGoal) {
            currentGoal.tasks.push(currentTask);
          }
          if (currentGoal) {
            config.goals.push(currentGoal);
          }
          const goalNum = goalMatch[1].includes('.') ? goalMatch[1] : `${goalMatch[1]}.0`;
          currentGoal = {
            id: goalNum,
            title: cleanText(goalMatch[2].replace(/\*\*/g, '')),
            tasks: []
          };
          currentTask = null;
          continue;
        }

        // Task header (e.g., "### 1.1 Task Title", "#### 1.1 Task Title", or "- **1.1** Task Title")
        const taskMatch = trimmed.match(/^#{3,4}\s*(\d+\.\d+)\s+(.+)$/) ||
                          trimmed.match(/^-\s*\*\*(\d+\.\d+)\*\*\s+(.+)$/);
        if (taskMatch && currentGoal) {
          if (currentTask) {
            currentGoal.tasks.push(currentTask);
          }
          currentTask = {
            id: taskMatch[1],
            title: cleanText(taskMatch[2].replace(/\*\*/g, '')),
            time: 30,
            links: [],
            notes: ''
          };
          continue;
        }

        // Task properties
        if (currentTask) {
          // Time â€” flexible format: 30m, 30 min, 1h, 2 hours, etc.
          const timeLineMatch = trimmed.match(/^-?\s*\*?\*?Time\*?\*?:\s*(.+)$/i);
          if (timeLineMatch) {
            const rawTime = timeLineMatch[1].replace(/\*\*/g, '').trim();
            if (rawTime) {
              const minutes = parseTime(rawTime);
              if (minutes === null) {
                config.errors.push(`Task "${currentTask.title}": could not parse time "${rawTime}". Use a number followed by a unit (e.g. 30m, 1h, 60 min).`);
              } else if (!VALID_TIMES.includes(minutes)) {
                config.errors.push(`Task "${currentTask.title}": time "${rawTime}" resolves to ${minutes} min, which is not a valid option. Must be one of: 15 min, 30 min, 60 min (1h), 120 min (2h).`);
              } else {
                currentTask.time = minutes;
              }
            }
            continue;
          }

          // Link â€” handle **Link:** (colon inside bold) leaving ** before the value
          const linkMatch = trimmed.match(/^-?\s*\*?\*?Link\*?\*?:\s*\*?\*?\s*\[(.+?)\]\((.+?)\)/i) ||
                            trimmed.match(/^-?\s*\*?\*?Link\*?\*?:\s*\*?\*?\s*(.+?)\s+(https?:\/\/.+)$/i);
          if (linkMatch) {
            currentTask.links.push({
              label: cleanText(linkMatch[1]),
              url: linkMatch[2].trim()
            });
            continue;
          }

          // Notes
          const notesMatch = trimmed.match(/^-?\s*\*?\*?Notes?\*?\*?:\s*(.+)$/i);
          if (notesMatch) {
            currentTask.notes = cleanText(notesMatch[1]);
            continue;
          }
        }
      }

      // Don't forget the last task and goal
      if (currentTask && currentGoal) {
        currentGoal.tasks.push(currentTask);
      }
      if (currentGoal) {
        config.goals.push(currentGoal);
      }

      // Auto-renumber goals and tasks sequentially
      config.goals.forEach((goal, gIndex) => {
        const goalNum = gIndex + 1;
        goal.id = `${goalNum}.0`;
        goal.tasks.forEach((task, tIndex) => {
          task.id = `${goalNum}.${tIndex + 1}`;
        });
      });

      return config;
    }

    function generateDiff(oldConfig, newConfig) {
      const diff = {
        quarterChanged: oldConfig.quarter !== newConfig.quarter,
        oldQuarter: oldConfig.quarter,
        newQuarter: newConfig.quarter,
        goalsAdded: [],
        goalsRemoved: [],
        goalsUnchanged: [],
        tasksAdded: [],
        tasksRemoved: []
      };

      const oldGoalIds = new Set(oldConfig.goals.map(g => g.id));
      const newGoalIds = new Set(newConfig.goals.map(g => g.id));

      newConfig.goals.forEach(g => {
        if (!oldGoalIds.has(g.id)) {
          diff.goalsAdded.push(g);
        } else {
          diff.goalsUnchanged.push(g);
        }
      });

      oldConfig.goals.forEach(g => {
        if (!newGoalIds.has(g.id)) {
          diff.goalsRemoved.push(g);
        }
      });

      // Task-level diff
      const oldTaskIds = new Set();
      oldConfig.goals.forEach(g => g.tasks.forEach(t => oldTaskIds.add(t.id)));
      
      const newTaskIds = new Set();
      newConfig.goals.forEach(g => g.tasks.forEach(t => newTaskIds.add(t.id)));

      newConfig.goals.forEach(g => {
        g.tasks.forEach(t => {
          if (!oldTaskIds.has(t.id)) {
            diff.tasksAdded.push({ goal: g.title, task: t });
          }
        });
      });

      oldConfig.goals.forEach(g => {
        g.tasks.forEach(t => {
          if (!newTaskIds.has(t.id)) {
            diff.tasksRemoved.push({ goal: g.title, task: t });
          }
        });
      });

      return diff;
    }

    function renderDiff(diff) {
      let html = '';

      if (diff.quarterChanged) {
        html += `
          <div class="diff-section">
            <div class="diff-section-title">Quarter</div>
            <div class="diff-item removed">${escapeHtml(diff.oldQuarter)}</div>
            <div class="diff-item added">${escapeHtml(diff.newQuarter)}</div>
          </div>
        `;
      }

      if (diff.goalsAdded.length > 0) {
        html += `
          <div class="diff-section">
            <div class="diff-section-title">New Goals</div>
            ${diff.goalsAdded.map(g => `<div class="diff-item added">+ ${escapeHtml(g.title)}</div>`).join('')}
          </div>
        `;
      }

      if (diff.goalsRemoved.length > 0) {
        html += `
          <div class="diff-section">
            <div class="diff-section-title">Removed Goals</div>
            ${diff.goalsRemoved.map(g => `<div class="diff-item removed">- ${escapeHtml(g.title)}</div>`).join('')}
          </div>
        `;
      }

      if (diff.tasksAdded.length > 0) {
        html += `
          <div class="diff-section">
            <div class="diff-section-title">New Tasks</div>
            ${diff.tasksAdded.map(t => `<div class="diff-item added">+ ${escapeHtml(t.task.title)}</div>`).join('')}
          </div>
        `;
      }

      if (diff.tasksRemoved.length > 0) {
        html += `
          <div class="diff-section">
            <div class="diff-section-title">Removed Tasks</div>
            ${diff.tasksRemoved.map(t => `<div class="diff-item removed">- ${escapeHtml(t.task.title)}</div>`).join('')}
          </div>
        `;
      }

      if (!html) {
        html = '<div class="diff-item unchanged">No changes detected</div>';
      }

      return html;
    }

    // ============ TOAST ============
    function showToast(message, duration = 2500) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), duration);
    }

    // ============ CONFIG UPLOAD ============
    let pendingConfig = null;

    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('upload-input').click();
    });

    document.getElementById('upload-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const content = event.target.result;
        pendingConfig = parseConfig(content);

        const diff = generateDiff(
          { quarter: state.quarter, goals: state.goals },
          pendingConfig
        );

        let errorHtml = '';
        const confirmBtn = document.getElementById('diff-confirm');
        if (pendingConfig.errors && pendingConfig.errors.length > 0) {
          errorHtml = `
            <div class="diff-errors">
              <div class="diff-error-title">Errors</div>
              ${pendingConfig.errors.map(e => `<div class="diff-error-item">${escapeHtml(e)}</div>`).join('')}
            </div>
          `;
          confirmBtn.classList.add('btn-disabled');
        } else {
          confirmBtn.classList.remove('btn-disabled');
        }

        document.getElementById('diff-content').innerHTML = errorHtml + renderDiff(diff);
        document.getElementById('diff-overlay').classList.add('visible');
      };
      reader.readAsText(file);
      
      // Reset input so same file can be uploaded again
      e.target.value = '';
    });

    document.getElementById('diff-cancel').addEventListener('click', () => {
      pendingConfig = null;
      document.getElementById('diff-overlay').classList.remove('visible');
    });

    document.getElementById('diff-confirm').addEventListener('click', () => {
      if (pendingConfig && (!pendingConfig.errors || pendingConfig.errors.length === 0)) {
        const taskCount = pendingConfig.goals.reduce((sum, g) => sum + g.tasks.length, 0);
        state.quarter = pendingConfig.quarter;
        state.goals = pendingConfig.goals;
        // Keep taskState intact - matching IDs retain their completion status
        saveState();
        renderGoals();
        renderToday();
        showToast(`Config loaded â€” ${pendingConfig.goals.length} goals, ${taskCount} tasks`);
      }
      pendingConfig = null;
      document.getElementById('diff-overlay').classList.remove('visible');
      document.getElementById('diff-confirm').classList.remove('btn-disabled');
    });

    // ============ MENU & RESET ============
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');

    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle('open');
    });

    document.addEventListener('click', () => {
      menuDropdown.classList.remove('open');
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      menuDropdown.classList.remove('open');
      document.getElementById('confirm-overlay').classList.add('visible');
    });

    document.getElementById('confirm-cancel').addEventListener('click', () => {
      document.getElementById('confirm-overlay').classList.remove('visible');
    });

    document.getElementById('confirm-reset').addEventListener('click', () => {
      localStorage.removeItem('focus-app-v2');
      state.taskState = {};
      state.deferredThisSession = {};
      loadDefaultConfig();
      renderGoals();
      renderToday();
      document.getElementById('confirm-overlay').classList.remove('visible');
      showToast('Reset to default');
    });

    // ============ NAVIGATION ============
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.view;
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');

        // Re-render active view
        if (view === 'goals') renderGoals();
        if (view === 'today') renderToday();
      });
    });

    // ============ INIT ============
    initLockScreen();
    loadState();
    renderGoals();
    renderToday();
  </script>
</body>
</html>
